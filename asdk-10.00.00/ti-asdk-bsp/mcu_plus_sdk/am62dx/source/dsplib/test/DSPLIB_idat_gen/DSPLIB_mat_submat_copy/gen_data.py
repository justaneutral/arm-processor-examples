from __future__ import print_function
from subprocess import call
from sys import platform

import sys
import numpy as np
import scipy as sp
import csv

sys.path.append("../common")
import DSPLIB_utils
import file_io


def gen_testCaseParams(testParamsFile, currPrm):
    """Generate and write test case parameters to idat file

    Args:
        param1 (file object): Input file object to idat.c file
        param2 (dict object): Dict object with test case parameter

    """

    testId = currPrm["ID"]
    dType = currPrm["dType"]
    widthX = currPrm["widthX"]
    heightX = currPrm["heightX"]
    nCols = currPrm["nCols"]
    nRows = currPrm["nRows"]
    strideX = currPrm["strideX"]
    strideY = currPrm["strideY"]
    direction = currPrm["dir"]
    stRow     = currPrm["stRow"]
    stCol     = currPrm["stCol"]
    testType = currPrm["testType"]
    demoCase = currPrm["demoCase"]
    outputDataLocation = currPrm["outputDataLocation"]
    numReps = currPrm["numReps"]

    if testType == "STATIC":
        X = "staticRefXCase" + testId
        Y = "staticRefYCase" + testId
    else:
        X = "NULL"
        Y = "NULL"   
    if direction == 0:
        out0 = Y
    else:
        out0 = X   
        
      

    if demoCase == "true":
        testParamsFile.write(
            "#if (defined(ALL_TEST_CASES) || (TEST_CASE == %d) || defined(DEMO_CASE))\n"
            % (int(testId))
        )
    else:
        testParamsFile.write(
            "#if (defined(ALL_TEST_CASES) || (TEST_CASE == %d))\n" % (int(testId))
        )

    idatFile.write("{\n")
    idatFile.write("%s,                                                              // Test pattern \n" % ((testType)))
    idatFile.write("%s, // X matrix  \n" % ((X)))
    idatFile.write("%s, // Y matrix  \n" % ((Y)))
    idatFile.write("%s, // Output matrix \n" % ((out0)))
    idatFile.write("%s, // dataType \n" % ((DSPLIB_utils.resolve_dType(dType))))
    idatFile.write("%s, // widthX \n" % ((widthX)))
    idatFile.write("%s, // heightX \n" % ((heightX)))
    idatFile.write("DSPLIB_CALC_STRIDE(%s * sizeof(%s), DSPLIB_ALIGN_SHIFT_64BYTES), // stride of X matrix \n" % ((strideX), (dType)))
    idatFile.write("%s, // dir \n" % ((direction)))
    idatFile.write("%s, // Starting row number \n" % ((stRow)))
    idatFile.write("%s, // Starting col number \n" % ((stCol)))
    idatFile.write("%s, // nCols \n" % ((nCols)))
    idatFile.write("%s, // nRows \n" % ((nRows)))
    idatFile.write("DSPLIB_CALC_STRIDE(%s * sizeof(%s), DSPLIB_ALIGN_SHIFT_64BYTES), // stride of Y matrix \n" % ((strideY), (dType)))
    idatFile.write("%s, // shift \n" % ((0)))            
    idatFile.write("%s, // Output data location \n" % (outputDataLocation))
    idatFile.write("%d, // number of reps. \n" % (int(numReps)))
    idatFile.write("%d, // test ID\n" % int(testId))
    idatFile.write("},\n")
    idatFile.write("#endif\n")

    idatFile.write("\n\n")


def gen_idat_file(idatFile, testCases):
    """Generate the idat file

    Args:
        param1 (file object): Input file object to idat.c file
        param2 (dict object): Dict object with test case parameter

    """

    fIn = open("../common/ti_lice_header_idat.txt", "r")
    lines = fIn.readlines()
    fIn.close()
    idatFile.writelines(lines)
    includeString = '#include "DSPLIB_mat_submat_copy_idat.h"'
    idatFile.writelines(includeString)
    idatFile.write("\n")
    idatFile.write("/*This file is autogenerated*/\n")
    idatFile.write("/*Please do not edit*/\n")
    idatFile.write("\n\n")
    # generate ifdefs for header files
    for testCase in testCases:
        if testCase["testType"] == "STATIC":
            DSPLIB_utils.gen_ifdefs(idatFile, testCase)

    # generate parameters for test cases
    idatFile.write("static DSPLIB_mat_submat_copy_testParams_t testParams[] =  ")
    idatFile.write("{\n")

    for testCase in testCases:
        gen_testCaseParams(idatFile, testCase)

    idatFile.write("};\n\n")
    fIn = open("test_param_function.txt", "r")
    lines = fIn.readlines()

    idatFile.writelines(lines)


def process_test_case(testCase):
    """Convert str to int for necessary parameters

    Args:
        Param1(:obj: dict) : Dictionary object with test case parameters

    Returns:
        Obj: Dictionary object with necessary parameters converted to int

    """

    #print(testCase.keys())
    testCase["testId"] = int(testCase["ID"])
    testCase["widthX"] = int(testCase["widthX"])
    testCase["heightX"] = int(testCase["heightX"])
    testCase["strideX"] = int(testCase["strideX"])
    testCase["nCols"] = int(testCase["nCols"])
    testCase["nRows"] = int(testCase["nRows"])
    testCase["strideY"] = int(testCase["strideY"])    
    testCase["dir"] = int(testCase["dir"])
    testCase["stRow"] = int(testCase["stRow"])
    testCase["stCol"] = int(testCase["stCol"])

    return testCase


def gen_test_case_header_file(testCase):
    """Generate test case and write out input, filter, and output tensor
    into a header file usable in C/C++ code.

    Args:
        param1 (:obj: dict): A dict object with all the test case
        parameters

    Returns:
        [int int]: Minimum and maximum value in output feature tensor

    """

    ##############################
    # Get test parameter of case #
    ##############################

    testId = testCase["ID"]
    dType = testCase["dType"]
    direction = testCase["dir"]
    stRow     = testCase["stRow"]
    stCol     = testCase["stCol"]    
    nCols     = testCase["nCols"]
    nRows     = testCase["nRows"]    
    widthIn  = testCase["widthX"]
    heightIn = testCase["heightX"]
    [minVal, maxVal] = [-10, 10]
        
    if dType[0] == "f":
        dType = dType + "32"

    elif dType[0] == "d":
        dType = dType
    else:
        # print(dType)
        dType = dType.rstrip("_t")
    # print(dType)
    X  = np.random.uniform(low=minVal, high=maxVal, size=(heightIn, widthIn)).astype(dType)
    Y  = np.random.uniform(low=minVal, high=maxVal, size=(nRows, nCols)).astype(dType)
    # print(X)
    # print(X[[0,1],[1,2]])
    # print(X[[0,1],[1,1]])
    # print(X[[0,1],[2,0]])
    # print(Y)
    # print(X)
    if direction == 0:
        Y[0:,0:] = X[stRow:(stRow+nRows),stCol:(stCol+nCols)]
    else:
        X[stRow:(stRow+nRows),stCol:(stCol+nCols)] = Y[0:,0:]

    headerFileName = "staticRefCase" + str(testId) + ".h"
    file_io.write_header_file(X, Y,testCase, headerFileName)

    # return [np.min(out0), np.max(out0)]
    return [0,0]


# CSV file with paratmeters for all test cases
testCasesCsvFile = "test_cases_list.csv"
testIdList = []  # list of test IDs that we want to generate test data
testIdList += range(1, 301)
#testIdList = [18]

# #############################################################################
# Open CSV file with test cases and generate header file with test data for #
# test cases of interest; based on testIdList                               #
#############################################################################

with open(testCasesCsvFile, encoding="utf-8-sig") as csv_file:
    testCaseReader = csv.DictReader(csv_file)
    testCases = list(testCaseReader)
    
    for testCase in testCases:
        testCase = process_test_case(testCase)
  
    for testCase in testCases:
        print(testCase["ID"])
        if int(testCase["ID"]) in testIdList:
            if testCase["testType"] == "STATIC":
                [minY, maxY] = gen_test_case_header_file(testCase)
                print(
                    "Test case generation completed for test ID",
                    testCase["ID"],
                    "w/ min:",
                    minY,
                    "and max",
                    maxY,
                )
            else:
                print("Skipping test case generation as tesType is RANDOM")

idatFileName = "../../DSPLIB_mat_submat_copy/DSPLIB_mat_submat_copy_idat.c"


##########################################################################
# Generate idat.cpp file by parsing all the test cases in the CSV file # #
##########################################################################


with open(idatFileName, "w") as idatFile:
    gen_idat_file(idatFile, testCases)


if platform == "linux" or platform == "linux2":
    call(["clang-format", "-style=file", "-i", idatFileName])
    call(["indent", "-nut", "-i3", "-c55", "-l200", idatFileName])
    call(["rm", idatFileName + "~"])  # remove backup file


print("Idat file generation completed")
