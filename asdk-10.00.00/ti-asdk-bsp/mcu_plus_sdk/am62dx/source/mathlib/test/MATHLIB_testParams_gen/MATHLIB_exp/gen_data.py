from __future__ import print_function
from subprocess import call
from sys import platform

import sys
import numpy as np
import csv

sys.path.append("../common")

import MATHLIB_utils
import file_io


def gen_testCaseParams(testParamsFile, currPrm):
    """Generate and write test case parameters to idat file

    Args:
        param1 (file object): Input file object to idat.c file
        param2 (dict object): Dict object with test case parameter

    """

    testId = currPrm["ID"]
    dType = currPrm["dTypeIn"]
    length = currPrm["length"]
    testType = currPrm["testType"]
    demoCase = currPrm["demoCase"]

    if testType == "STATIC":
        in0 = "staticRefInCase" + testId
        out = "staticRefOutCase" + testId
    else:
        in0 = "NULL"
        out = "NULL"

    if demoCase == "true":
        testParamsFile.write(
            "#if (defined(ALL_TEST_CASES) || (TEST_CASE == %d) || defined(DEMO_CASE))\n"
            % (int(testId))
        )
    else:
        testParamsFile.write(
            "#if (defined(ALL_TEST_CASES) || (TEST_CASE == %d))\n" % (int(testId))
        )

    testParamsFile.write("{\n")
    testParamsFile.write("%s, // Input vector \n" % ((in0)))
    testParamsFile.write("%s, // Output vector \n" % ((out)))
    testParamsFile.write("%s, // length of vector \n" % ((length)))
    testParamsFile.write("%s, // precision \n" % ((dType)))
    testParamsFile.write("%d, // test ID\n" % int(testId))
    testParamsFile.write("},\n")
    testParamsFile.write("#endif")
    testParamsFile.write("\n\n")


def gen_idat_file(testParamsFile, testCases):
    """Generate the idat file

    Args:
        param1 (file object): Input file object to idat.c file
        param2 (dict object): Dict object with test case parameter

    """

    fIn = open("../common/ti_lice_header_testParams.txt", "r")
    lines = fIn.readlines()
    fIn.close()
    testParamsFile.writelines(lines)
    includeString = '#include "MATHLIB_exp_testParams.h"'
    testParamsFile.writelines(includeString)
    testParamsFile.write("\n")
    testParamsFile.write("/*This file is autogenerated*/\n")
    testParamsFile.write("/*Please do not edit*/\n")
    testParamsFile.write("\n\n")
    # generate ifdefs for header files
    for testCase in testCases:
        if testCase["testType"] == "STATIC":
            MATHLIB_utils.gen_ifdefs(testParamsFile, testCase)

    # generate parameters for test cases
    testParamsFile.write("static MATHLIB_exp_testParams_t testParams[] =  ")
    testParamsFile.write("{\n")

    for testCase in testCases:
        gen_testCaseParams(testParamsFile, testCase)

    testParamsFile.write("};\n\n")
    fIn = open("test_param_function.txt", "r")
    lines = fIn.readlines()

    testParamsFile.writelines(lines)


def process_test_case(testCase):
    """Convert str to int for necessary parameters

    Args:
        Param1(:obj: dict) : Dictionary object with test case parameters

    Returns:
        Obj: Dictionary object with necessary parameters converted to int

    """

    # print(testCase.keys())
    testCase["testId"] = int(testCase["ID"])
    testCase["length"] = int(testCase["length"])
    testCase["minX"] = float(testCase["minX"])
    testCase["maxX"] = float(testCase["maxX"])

    return testCase


def gen_test_case_header_file(testCase):
    """Generate test case and write out input, filter, and output tensor
    into a header file usable in C/C++ code.

    Args:
        param1 (:obj: dict): A dict object with all the test case
        parameters

    Returns:
        [int int]: Minimum and maximum value in output feature tensor

    """

    ##############################
    # Get test parameter of case #
    ##############################

    testId = testCase["ID"]
    length = testCase["length"]
    dTypeIn = testCase["dTypeIn"]
    minX = testCase["minX"]
    maxX = testCase["maxX"]

    if dTypeIn == "MATHLIB_FLOAT32":
        in0 = np.random.uniform(minX, maxX, length).astype("float")
    else:
        in0 = np.random.uniform(minX, maxX, length).astype("double")

    out = np.exp(in0)
    out[out > np.finfo(np.float32).max] = np.finfo(np.float32).max
    out[out < np.finfo(np.float32).tiny] = 0
    headerFileName = "staticRefCase" + str(testId) + ".h"
    file_io.write_header_file(in0, out, testCase, headerFileName)

    return [np.min(out), np.max(out)]


# CSV file with paratmeters for all test cases
testCasesCsvFile = "test_cases_list.csv"
testIdList = []  # list of test IDs that we want to generate test data
testIdList += range(1, 4)


myArgs = MATHLIB_utils.getCmdLineArgs()


def gen_test_case(testCase):
    if testCase["testType"] == "STATIC":
        [minY, maxY] = gen_test_case_header_file(testCase)
        print(
            "Test case generation completed for test ID",
            testCase["ID"],
            "w/ min:",
            minY,
            "and max",
            maxY,
        )
    else:
        print(
            "Skipping test case generation for test ID",
            testCase["ID"],
            "as tesType is RANDOM",
        )


#############################################################################
# Open CSV file with test cases and generate header file with test data for #
# test cases of interest; based on testIdList                               #
#############################################################################

with open(testCasesCsvFile, encoding="utf-8-sig") as csv_file:
    testCaseReader = csv.DictReader(csv_file)
    testCases = list(testCaseReader)

    for testCase in testCases:
        testCase = process_test_case(testCase)

    for testCase in testCases:
        if myArgs.allCases == True:
            gen_test_case(testCase)
        elif int(testCase["ID"]) in testIdList:
            gen_test_case(testCase)


testParamsFileName = "../../MATHLIB_exp/MATHLIB_exp_testParams.cpp"


##########################################################################
# Generate idat.cpp file by parsing all the test cases in the CSV file # #
##########################################################################


with open(testParamsFileName, "w") as testParamsFile:
    gen_idat_file(testParamsFile, testCases)


# call(["clang-format", "-style=file", "-i", testParamsFileName])
if platform == "linux" or platform == "linux2":
    call(["indent", "-nut", "-i3", "-c55", "-l200", testParamsFileName])

call(["rm", testParamsFileName + "~"])  # remove backup file

print("Idat file generation completed")
